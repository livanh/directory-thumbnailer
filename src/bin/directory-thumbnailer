#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

function gtk_find_icon() {
    python -c "import gtk; print gtk.icon_theme_get_default().lookup_icon(\"$1\",$2,0).get_filename()"
}

if [ -z "$1" ]; then exit 0; fi

INFILE="$1"
OUTFILE="$2"
SIZE="$3"
thumbnail_file=""

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname poster.jpg)"
fi

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname poster.png)"
fi

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname folder.jpg)"
fi

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname .folder.jpg)"
fi

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname folder.png)"
fi

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname .folder.png)"
fi

if [ "${thumbnail_file}" == "" ]; then
    thumbnail_file="$(find ${INFILE} -maxdepth 1 -iname AlbumArtSmall.jpg)"
fi

if [ "${thumbnail_file}" == "" ] && [ -f "${INFILE}/.directory" ]; then 
    if crudini --get "${INFILE}/.directory" "Desktop Entry" Icon >/dev/null; then
        icon_file="$(crudini --get "${INFILE}/.directory" "Desktop Entry" Icon)"
        if [ -f "${icon_file}" ]; then
            thumbnail_file="${icon_file}"
        elif [ -f "${INFILE}/${icon_file}" ]; then
            thumbnail_file="${INFILE}/${icon_file}"
        else
            thumbnail_file="$(gtk_find_icon ${icon_file} ${SIZE})"
            if [ "${thumbnail_file//*.}" == "svg" ]; then
                rsvg-convert -w ${SIZE} -h ${SIZE} "${thumbnail_file}" >"${OUTFILE}"
                thumbnail_file="${OUTFILE}"
            fi
        fi
    fi
fi

if ! [ -z "$thumbnail_file" ]; then 
    if [ -f "${thumbnail_file}" ]; then
        convert "${thumbnail_file}" -resize "${SIZE}x${SIZE}" "${OUTFILE}"
    else
        echo No usable image found!
    fi
else
    echo No usable image found!
fi
